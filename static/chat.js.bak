// public/chat.js

const chatContainer = document.getElementById("chat-container");
const userInput = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const micBtn = document.getElementById("mic-btn");
const faqToggle = document.getElementById("faq-toggle");
const faqPanel = document.getElementById("faq-panel");

const history = [];

// --- [TTS 음성합성 함수] ---
function speak(text) {
  if (!window.speechSynthesis) {
    alert("이 브라우저는 음성합성을 지원하지 않습니다.");
    return;
  }
  window.speechSynthesis.cancel(); // 이전 재생 중지
  const utter = new SpeechSynthesisUtterance(text.replace(/<[^>]+>/g, "")); // 태그 제거
  utter.lang = "ko-KR";
  utter.rate = 1;
  utter.pitch = 1;
  utter.volume = 1;
  window.speechSynthesis.speak(utter);
}

// --- 메시지 화면에 추가 (TTS 버튼 통합) ---
function addMessage(text, sender) {
  const msg = document.createElement("div");
  msg.classList.add("message", sender);

  if (sender === "bot") {
    msg.innerHTML = marked.parse(text);

    // TTS 버튼 추가
    const ttsBtn = document.createElement("button");
    ttsBtn.className = "tts-btn";
    ttsBtn.title = "음성으로 듣기";
    ttsBtn.innerHTML = `<span class="material-symbols-outlined">volume_up</span>`;
    ttsBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      // 마크다운 태그 제외 + 줄바꿈 정리해서 읽음
      const plain = msg.innerText;
      speak(plain);
    });
    msg.appendChild(ttsBtn);
    msg.style.paddingRight = "38px"; // 버튼 겹침 여백
  } else {
    msg.textContent = text;
  }

  chatContainer.append(msg);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// --- 로딩 표시/제거 ---
function setLoading(on) {
  if (on) {
    const load = document.createElement("div");
    load.id = "__loading";
    load.classList.add("message", "bot");
    load.textContent = "생각하는 중...";
    chatContainer.append(load);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  } else {
    const load = document.getElementById("__loading");
    if (load) load.remove();
  }
}

// --- 백엔드 호출 함수 ---
async function callChatAPI() {
  setLoading(true);
  try {
    const lastUser = history
      .slice()
      .reverse()
      .find((m) => m.role === "user");
    const question = lastUser ? lastUser.content : "";

    const res = await fetch("/api/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question }),
    });
    const data = await res.json();
    setLoading(false);

    const reply = (data.full || "").trim();
    addMessage(reply, "bot");
    history.push({ role: "assistant", content: reply });
  } catch (err) {
    setLoading(false);
    console.error(err);
    addMessage("서버 호출 중 오류가 발생했습니다.", "bot");
  }
}

// --- 메시지 전송 핸들러 ---
function sendMessage(e) {
  if (e) e.preventDefault();
  const text = userInput.value.trim();
  if (!text) return;
  addMessage(text, "user");
  history.push({ role: "user", content: text });
  userInput.value = "";
  callChatAPI();
}

sendBtn.addEventListener("click", sendMessage);
document.getElementById("chat-form").addEventListener("submit", sendMessage);
userInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});

// --- 음성인식 ---
let recognition;
if ("SpeechRecognition" in window || "webkitSpeechRecognition" in window) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = "ko-KR";
  recognition.interimResults = true;

  recognition.addEventListener("result", (e) => {
    const interim = Array.from(e.results)
      .map((r) => r[0].transcript)
      .join("");
    userInput.value = interim;
  });
  recognition.addEventListener("end", () => {
    if (userInput.value.trim()) sendMessage();
  });
} else {
  micBtn.disabled = true;
}
micBtn.addEventListener("click", () => {
  if (recognition) {
    userInput.value = "";
    recognition.start();
  }
});

// --- FAQ 토글 및 질문 클릭 ---
faqToggle.addEventListener("click", () => {
  const icon = faqToggle.querySelector("span");
  faqPanel.classList.toggle("open");
  icon.textContent = faqPanel.classList.contains("open")
    ? "chevron_left"
    : "arrow_forward";
});

document.querySelectorAll("#faq-panel li").forEach((item) => {
  item.addEventListener("click", () => {
    const q = item.textContent.trim();
    faqPanel.classList.remove("open");
    faqToggle.querySelector("span").textContent = "arrow_forward";
    addMessage(q, "user");
    history.push({ role: "user", content: q });
    callChatAPI();
  });
});

// 10) 초기 질문 처리 (URL 파라미터)
const params = new URLSearchParams(window.location.search);
const initial = params.get("q");
if (initial) {
  const decoded = decodeURIComponent(initial);
  addMessage(decoded, "user");
  history.push({ role: "user", content: decoded });
  callChatAPI();
}
// 11) 하단 점3개 메뉴 기능
const menuBtn = document.getElementById("menu-btn");
const menuPanel = document.getElementById("menu-panel");
const menuHome = document.getElementById("menu-home");
const menuHistory = document.getElementById("menu-history");

menuBtn.addEventListener("click", () => {
  menuPanel.classList.toggle("open");
});

menuHome.addEventListener("click", () => {
  window.location.href = "/";
});

menuHistory.addEventListener("click", () => {
  alert("History 기능은 추후 업데이트 예정입니다!");
  // 혹은 별도의 히스토리 페이지 연결 가능
});

// 외부 클릭 시 메뉴 닫힘
document.addEventListener("click", (e) => {
  if (!menuBtn.contains(e.target) && !menuPanel.contains(e.target)) {
    menuPanel.classList.remove("open");
  }
});
